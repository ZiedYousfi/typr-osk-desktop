name: Build (Windows)

on:
  workflow_call:
    inputs:
      artifact_name:
        required: true
        type: string
      exe_path:
        required: false
        type: string
      skip_deploy:
        required: false
        type: boolean
        default: false

jobs:
  build:
    name: Build Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Install Meson, Ninja, and Conan
        run: pip install meson ninja conan

      - name: Install pkgconfiglite (Windows)
        run: choco install pkgconfiglite

      - name: Clean PATH (Windows)
        run: |
          $env:PATH = ($env:PATH -split ';' | Where-Object { $_ -notmatch 'Strawberry' -and $_ -notmatch 'Git' -and $_ -notmatch 'mingw' }) -join ';'
          "PATH=$env:PATH" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append

      - name: Setup MSVC (Windows)
        uses: ilammy/msvc-dev-cmd@v1

      - name: Setup Conan profile
        run: conan profile detect --force

      - name: Install Dependencies (Conan)
        run: conan install . --output-folder=conan-build --build=missing -s build_type=Release -s compiler.cppstd=20

      - name: Configure Meson
        env:
          PKG_CONFIG: pkg-config
          PKG_CONFIG_PATH: ${{ github.workspace }}\conan-build
          CMAKE_PREFIX_PATH: ${{ github.workspace }}\conan-build
        run: meson setup build --native-file conan-build/conan_meson_native.ini --buildtype release

      - name: Build
        run: meson compile -C build

      - name: Locate windeployqt.exe
        if: ${{ inputs.skip_deploy == false && inputs.exe_path != '' && runner.os == 'Windows' }}
        id: find-windeployqt
        shell: pwsh
        run: |
          Write-Host 'Searching for windeployqt.exe in conan-build and on PATH...'
          # Prefer file system hits from conan-build if present
          $foundItem = Get-ChildItem -Path conan-build -Recurse -Filter windeployqt.exe -ErrorAction SilentlyContinue | Select-Object -First 1
          $foundPath = ''
          if ($foundItem) {
            $foundPath = $foundItem.FullName
          } else {
            Write-Host 'Not found in conan-build; checking PATH...'
            $cmd = Get-Command windeployqt.exe -ErrorAction SilentlyContinue
            if ($cmd) {
              # Get-Command returns a CommandInfo object; use the Path property to get the executable path
              $foundPath = $cmd.Path
            }
          }
          if ($foundPath) {
            Write-Host "Found windeployqt at $foundPath"
            "qt_tools_path=$foundPath" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Host 'windeployqt.exe not found; leaving qt_tools_path empty'
            "qt_tools_path=" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          }

      - name: Deploy Qt (Windows)
        if: ${{ inputs.skip_deploy == false && inputs.exe_path != '' }}
        uses: ./.github/actions/deploy-qt-dlls
        with:
          exe_path: ${{ inputs.exe_path }}
          qt_tools_path: ${{ steps.find-windeployqt.outputs.qt_tools_path }}

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.artifact_name }}
          path: build/
